package transform_test

import (
	"testing"

	"github.com/snyk/cli-extension-os-flows/internal/legacy/transform"

	"github.com/snyk/go-application-framework/pkg/apiclients/testapi"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestConvertExploit_EmptySourcesAndMaturityLevels_ReturnsNil(t *testing.T) {
	snykExploitDetails := &testapi.SnykvulndbExploitDetails{
		Sources:        []string{},
		MaturityLevels: []testapi.SnykvulndbExploitMaturityLevel{},
	}

	exploitDetails, exploit := transform.ConvertExploit(snykExploitDetails)

	assert.Nil(t, exploitDetails)
	assert.Nil(t, exploit)
}

func TestConvertExploit_OnlyMaturityLevelsProvided_ReturnsExploitDetails(t *testing.T) {
	snykExploitDetails := &testapi.SnykvulndbExploitDetails{
		Sources: []string{},
		MaturityLevels: []testapi.SnykvulndbExploitMaturityLevel{
			{
				Format: "CVSS",
				Level:  "high",
				Type:   testapi.SnykvulndbCvssSourceTypePrimary,
			},
		},
	}

	exploitDetails, exploit := transform.ConvertExploit(snykExploitDetails)

	require.NotNil(t, exploitDetails)
	assert.Empty(t, exploitDetails.Sources)
	require.Len(t, exploitDetails.MaturityLevels, 1)
	assert.Equal(t, "CVSS", exploitDetails.MaturityLevels[0].Format)
	assert.Equal(t, "High", exploitDetails.MaturityLevels[0].Level)
	assert.Equal(t, "primary", exploitDetails.MaturityLevels[0].Type)
	require.NotNil(t, exploit)
	assert.Equal(t, "High", *exploit)
}

func TestConvertExploit_FullExploitDetails_ReturnsCompleteData(t *testing.T) {
	snykExploitDetails := &testapi.SnykvulndbExploitDetails{
		Sources: []string{"https://example.com/exploit1", "https://example.com/exploit2"},
		MaturityLevels: []testapi.SnykvulndbExploitMaturityLevel{
			{
				Format: "CVSS",
				Level:  "functional",
				Type:   testapi.SnykvulndbCvssSourceTypeSecondary,
			},
			{
				Format: "EPSS",
				Level:  "proof of concept",
				Type:   testapi.SnykvulndbCvssSourceTypePrimary,
			},
		},
	}

	exploitDetails, exploit := transform.ConvertExploit(snykExploitDetails)

	require.NotNil(t, exploitDetails)
	assert.Equal(t, []string{"https://example.com/exploit1", "https://example.com/exploit2"}, exploitDetails.Sources)
	require.Len(t, exploitDetails.MaturityLevels, 2)
	assert.Equal(t, "CVSS", exploitDetails.MaturityLevels[0].Format)
	assert.Equal(t, "Functional", exploitDetails.MaturityLevels[0].Level)
	assert.Equal(t, "secondary", exploitDetails.MaturityLevels[0].Type)
	assert.Equal(t, "EPSS", exploitDetails.MaturityLevels[1].Format)
	assert.Equal(t, "Proof of Concept", exploitDetails.MaturityLevels[1].Level)
	assert.Equal(t, "primary", exploitDetails.MaturityLevels[1].Type)
	require.NotNil(t, exploit)
	assert.Equal(t, "Proof of Concept", *exploit)
}

func TestConvertExploit_OnlySourcesProvided_Returns(t *testing.T) {
	snykExploitDetails := &testapi.SnykvulndbExploitDetails{
		Sources:        []string{"https://example.com/exploit"},
		MaturityLevels: []testapi.SnykvulndbExploitMaturityLevel{},
	}

	exploitDetails, exploit := transform.ConvertExploit(snykExploitDetails)

	require.NotNil(t, exploitDetails)
	assert.NotEmpty(t, exploitDetails.Sources)
	assert.Nil(t, exploit)
}

func TestMaturityLevelDisplayText(t *testing.T) {
	assert.Equal(t, "Attacked", transform.MaturityLevelDisplayText("attacked"))
	assert.Equal(t, "Functional", transform.MaturityLevelDisplayText("functional"))
	assert.Equal(t, "High", transform.MaturityLevelDisplayText("high"))
	assert.Equal(t, "Not Defined", transform.MaturityLevelDisplayText("not defined"))
	assert.Equal(t, "Proof of Concept", transform.MaturityLevelDisplayText("proof of concept"))
	assert.Equal(t, "Unproven", transform.MaturityLevelDisplayText("unproven"))
	assert.Equal(t, "Unreported", transform.MaturityLevelDisplayText("unreported"))

	assert.Equal(t, "not a known value", transform.MaturityLevelDisplayText("not a known value"))
}
